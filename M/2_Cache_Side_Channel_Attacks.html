<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Cache Side Channel Attacks - teja&#x27;s notes</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
                <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../Preface.html">Preface</a></li><li class="chapter-item expanded "><a href="../N_Linux_Networking.html">N. Linux_Networking</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../N/1_setup_qemu.html">N1. Setup Qemu</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../N/1_setup_uml.html">N1. Setup UML (older)</a></li></ol></li><li class="chapter-item expanded "><a href="../N/2_Packet_RX_Basic.html">N2. Packet RX path 1 : Basic</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../N/2_1-3_top_half_processing.html">N2.1-N2.3 Top Half Processing</a></li><li class="chapter-item expanded "><a href="../N/2_4-5_bottom_half_processing.html">N2.4-N2.5 Bottom Half Processing</a></li><li class="chapter-item expanded "><a href="../N/2_6-7_ip_and_udp_processing.html">N2.6-N2.7 IP and UDP Processing</a></li></ol></li><li class="chapter-item expanded "><a href="../N/3_Packet_TX_Basic.html">N3. Packet TX path 1 : Basic</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../N/3_1-3_sendmsg_from_userspace.html">N3.1-3.2 sendmsg() from userspace</a></li><li class="chapter-item expanded "><a href="../N/3_3-4_alloc_and_send_skb.html">N3.3-3.4 alloc skb and send_skb</a></li><li class="chapter-item expanded "><a href="../N/3_5-8_net_tx_and_driver_xmit.html">N3.5-3.8 NET_TX and driver xmit</a></li></ol></li><li class="chapter-item expanded "><a href="../N/4_Socket_Programming_BTS.html">N4. (WIP) Socket Programming BTS</a></li></ol></li><li class="chapter-item expanded "><a href="../M_Miscellaneous.html">M. Miscellaneous</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../M/1_CSE222a_Notes.html">CSE 222a, Notes</a></li><li class="chapter-item expanded "><a href="../M/2_Cache_Side_Channel_Attacks.html" class="active">Cache Side Channel Attacks</a></li></ol></li><li class="chapter-item expanded "><a href="../Appendix.html">A. Appendix</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">teja&#x27;s notes</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="cache-side-channel-attacks"><a class="header" href="#cache-side-channel-attacks">Cache Side Channel Attacks</a></h1>
<p>By design caches are transparent, but processes can create contention resulting in timing variations.    CPU data cache timing attacks are to exploit cache timing to expose cache's internal state. </p>
<p>Caches are one place where time variations can be exposed.  Caches are built to bridge the gap between main memory and Processor  registers. Since it takes fewer cycles to read from cache than from main memory, recording time differences makes reading from cache detectable.</p>
<h3 id="caches-recap"><a class="header" href="#caches-recap">Caches Recap:</a></h3>
<ul>
<li>Caches are designed to exploit spatial locality in memory access</li>
<li>For each read, check if the data is present in one of the  caches. If present, read from the cache or load from lower memory. LRU  to evict old entries. </li>
<li>Cold cache misses are when the cache is empty, happens during program load.</li>
<li>Data can only be added to certain regions in the cache.  Multiple address lines in lower memory map to a subset in the cache.  Conflict miss happens when data that map to the same region are being  loaded, causing unnecessary cache evictions.</li>
<li>If cache size is larger than the working set of memory, we face capacity misses.</li>
<li>Write through cache: each write is immediately written to lower levels. Simple logic, but increases bus traffic</li>
<li>Write-back cache: write to cache, defer updating lower levels till it is evicted from the cache.</li>
<li>Cache Coherence: The same data can be present on multiple  caches, if one of the processors makes a change to common data, the  processor needs to make sure that cached data is consistent.</li>
<li>A Cache Coherence protocol makes sure of cache coherence  among caches. Cache coherence protocols described below are snooping  protocols, i.e. changes to cache traffic is visible to all cores.</li>
<li>Write-invalidate: On detecting a write to another cached location, invalidate local copy, forcing a read from main memory.</li>
<li>Write-update: On detecting a write, update local copy.</li>
<li>Any cache coherence protocol increases bus traffic. </li>
<li>Article on cache coherence : <a href="https://fgiesen.wordpress.com/2014/07/07/cache-coherency/">https://fgiesen.wordpress.com/2014/07/07/cache-coherency/</a> </li>
<li>Notes on CPU caches: <a href="https://www.cse.iitb.ac.in/%7Emythili/os/notes/notes-cache.txt">https://www.cse.iitb.ac.in/~mythili/os/notes/notes-cache.txt</a>
<ul>
<li>has a clean explanation of MESI cache coherence protocol.</li>
</ul>
</li>
<li>Code patterns to improve cache performance:
<ul>
<li>Build loops, which operate on the same data. Merge loops if necessary</li>
<li>Within a data structure, make sure critical (read/write heavy) elements are cache aligned and at the top.</li>
<li>Reduce branches so code can be prefetched.</li>
<li>Atomic variables are allowed to be present only in one  cache. Use of atomic variables (and hence locks and synchronization  mechanisms) on multiple cores increases cache coherence traffic. </li>
<li>Instead try to use per CPU data structures.</li>
</ul>
</li>
</ul>
<h3 id="flushreload-paradigm"><a class="header" href="#flushreload-paradigm">Flush+Reload Paradigm.</a></h3>
<ul>
<li>Exploits Cache behavior to leak information about victim process.</li>
<li>Flush a line, wait for some time, measure access time. If  the victim has accessed the memory, access time will be in cache and  access will be fast. Else will be slow.</li>
<li>Repeat to identify victim's memory regions.</li>
<li>Slides Link: <a href="https://cs.adelaide.edu.au/%7Eyval/CHES16/">https://cs.adelaide.edu.au/~yval/CHES16/</a></li>
</ul>
<h3 id="spectre-1-bounds-check-bypass"><a class="header" href="#spectre-1-bounds-check-bypass">Spectre 1: Bounds Check Bypass:</a></h3>
<ul>
<li>
<p>Modern CPUs can speculatively execute instructions in a branch, before a branch true execution starts. </p>
</li>
<li>
<pre><code>int some_function(int user_input)
{
    int x = 0;
    int flush_reload_buffer[256];
    if (check user_input) {  // on checking user_input, undo changes to x
        x = secret_array[user_input];  // this is executed. before check.
                                       // contents leak into the cache.
    }
    y = flush_reload_buffer[x];
    leak = measure_access_time_of_all_elements(flush_reload_buffer);
} 
</code></pre>
</li>
<li>
<p>The CPU based on historic data, tries to predict branches and  executes instructions in the branch. Later it checks the branch check,  if the instructions it ran were incorrect, it undoes all the changes.  These changes are transparent for the user. But the instructions in the  branch load data into the cache. This data can then be identified by  cache timing.</p>
</li>
<li>
<p>This can be used to read data from the kernel via eBPF JIT.  Users can provide eBPF  bytecode which the kernel runs at certain kernel hooks. The bytecode is translated into machine code using a JIT engine.</p>
</li>
<li>
<p>HW Solution is to clean up cache while undoing changes. </p>
</li>
</ul>
<h3 id="spectre-2-branch-target-injection"><a class="header" href="#spectre-2-branch-target-injection">Spectre 2: Branch target injection:</a></h3>
<ul>
<li>Independent execution of the same code, can influence branch predictions. Earlier people worked on inferring  details about the  victim based on attacker's branch prediction. This attack instead forces victim's branch prediction due to attacker's choice of branch  execution.</li>
<li>Most branch predictors maintain a table of branches to jump  addresses. The last 12 bits are used to identify the branches and  addresses.</li>
<li>Since Only the last 12 bits are used, the attacker fills the table with branch and jump entries. The CPU while executing the victim  code enters the branch and loads the secret into the cache, which is  then read by the attacker. Note that the victim might itself have never  entered the branch, but the CPU speculatively executes the branch.</li>
<li>This can be used to read the host's memory from a KVM guest.</li>
<li>HW Solution: Update microcode so OS can control branch prediction table. </li>
<li>SW Retpoline Solution: Retpoline = return + trampoline. An  indirect branch that is not subject to speculative execution. Instead of a &quot;jmp&quot; use a call and return. <a href="https://support.google.com/faqs/answer/7625886">Google Blog.</a></li>
</ul>
<h3 id="spectre-3-rogue-data-cache-load"><a class="header" href="#spectre-3-rogue-data-cache-load">Spectre 3: Rogue data cache load</a></h3>
<ul>
<li>
<p>This attack exploits the fact that the CPU executes instructions in parallel, sometimes out of order to achieve parallelism.</p>
</li>
<li>
<pre><code>mov rax, [Somekerneladdress]
mov rbx, [someusermodeaddress] 
</code></pre>
</li>
<li>
<p>In the above example, the first instruction causes an  exception. But if the CPU runs both of them in parallel, the second one  can load user data into the cache before the exception occurs. Using  Flush+Reload data address can be identified.</p>
</li>
</ul>
<h3 id="meltdown"><a class="header" href="#meltdown">Meltdown:</a></h3>
<ul>
<li>This attack specifically tries to read kernel data from  userspace. It does this by trying to load a kernel address. The CPU loads the address and then raises an exception. This loads the data into the  cache which is then read using Flush+Reload. Similar to Spectre v3 but  the implementation is specific to Intel.</li>
</ul>
<h3 id="ridl"><a class="header" href="#ridl">RIDL:</a></h3>
<ul>
<li>Other parts of the CPU from which similar data can leak. <a href="https://mdsattacks.com/">https://mdsattacks.com/</a></li>
<li><a href="https://mdsattacks.com/slides/slides.html">https://mdsattacks.com/slides/slides.html</a></li>
</ul>
<h3 id="mitigations"><a class="header" href="#mitigations">Mitigations</a></h3>
<p>KAISER: an implementation to hide kernel data from userspace. <a href="https://lwn.net/Articles/738975/">Link</a></p>
<p>Meltdown and Spectre cause a performance Impact of 8 to 20% to IO intensive workloads, &lt;5 % impact on CPU intensive. (<a href="https://access.redhat.com/articles/3307751">Source</a>)</p>
<p>On my AMD Ryzen 5 PRO 3500U Laptop:</p>
<pre><code>$ grep . /sys/devices/system/cpu/vulnerabilities/*
itlb_multihit:Not affected
l1tf:Not affected
mds:Not affected
meltdown:Not affected
spec_store_bypass:Mitigation: Speculative Store Bypass disabled via prctl and seccomp
spectre_v1:Mitigation: usercopy/swapgs barriers and __user pointer sanitization
spectre_v2:Mitigation: Full AMD retpoline, IBPB: conditional, STIBP: disabled, RSB filling
tsx_async_abort:Not affected 
</code></pre>
<ul>
<li>Google zero blog <a href="https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html">link</a> .</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../M/1_CSE222a_Notes.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../Appendix.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../M/1_CSE222a_Notes.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../Appendix.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
